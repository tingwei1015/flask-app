<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å€‹äººä»‹é¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* å¤–æ¡†èˆ‡å…±ç”¨æ¨£å¼ */
  body{
    font-family: Arial, sans-serif;
    color:#333;
    margin:0;
    padding:24px;
    background:#f7f7f7;
  }
  .wrap{
    max-width:1000px;
    margin:0 auto;
    padding:0 16px;
    box-sizing:border-box;
  }
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  a.link{color:#2563eb;text-decoration:none}
  .flash{background:#fde68a;color:#92400e;padding:10px;border-radius:8px;margin:10px 0}

  /* ç‰ˆé¢ï¼šå·¦é ­åƒã€å³è³‡æ–™ï¼ˆæ•´åˆç‚ºå–®ä¸€å®£å‘Šï¼›è£œä¸Šç¼ºæ¼åˆ†è™Ÿï¼‰ */
  .grid{
    display:grid;
    grid-template-columns: 300px minmax(0,1fr);
    gap:20px;                 /* â† é€™è£¡ä¸€å®šè¦åˆ†è™Ÿ */
    align-items:start;
  }

  /* å¡ç‰‡é€šç”¨æ¨£å¼ + é˜²å¤–å‡¸ */
  .card{
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:18px;
    box-sizing:border-box;
    overflow:hidden;          /* é˜²æ­¢å…§å®¹æŠŠå¡ç‰‡æ’çˆ† */
  }
  /* å¡ç‰‡å…§ä»»ä½•å…ƒç´ æœ€å°å¯¬åº¦æ­¸é›¶ï¼Œé¿å…è¢«é•·å­—/é•·URLæ’ç ´ */
  .card *{ min-width:0; }

  /* é ­åƒ */
  .avatar{
    width:180px;height:180px;border-radius:50%;
    object-fit:cover;background:#f3f4f6;border:1px solid #ddd;
    display:block;margin:0 auto;
  }

  /* è¡¨å–®å…ƒä»¶ï¼ˆå¯¬åº¦ 100% ä¸¦ä¸æº¢å‡ºå¡ç‰‡ï¼‰ */
  .row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  input,textarea{
    padding:10px 12px;
    border:1px solid #ccc;
    border-radius:8px;
    width:100%;
    max-width:100%;
    box-sizing:border-box;
  }
  button{background:#967AA1;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .meta{font-size:14px;color:#666;margin-top:6px}

  /* æª”æ¡ˆé¸æ“‡åˆ—å¯æ›è¡Œï¼Œé¿å…é•·æª”åæ’ç ´ */
  .avatar-form .file-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .avatar-form input[type="file"]{
    flex:1 1 260px;
    max-width:100%;
  }

  /* Bio æ–‡å­—æ¡†ï¼šå¯æ‹‰é«˜ï¼Œä½†ä¸è¶…å‡ºå¡ç‰‡ */
  #bioTextarea{
    width:100%;
    max-width:100%;
    resize:vertical;
    min-height:90px;
  }

  /* æ‰‹æ©Ÿ RWDï¼šæ”¹å–®æ¬„ */
  @media (max-width: 900px){
    .grid{ grid-template-columns: 1fr; }
  }

  /* Cropper è£åˆ‡è¦–çª—åœ“å½¢é è¦½ï¼ˆè®“è£åˆ‡æ¡†çœ‹èµ·ä¾†æ˜¯åœ“çš„ï¼‰ */
  .cropper-view-box,
  .cropper-face{ border-radius:50%; }

  /* é€šç”¨å½ˆçª—ï¼ˆè‹¥ä½ å°ˆæ¡ˆå·²ç¶“æœ‰ modal æ¨£å¼ï¼Œå¯ç•¥éï¼‰ */
  .modal-mask{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:flex; justify-content:center; align-items:center;
    z-index:9999; padding:16px; box-sizing:border-box;
  }
  .modal-card{
    background:#fff; border-radius:12px; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.2);
	max-height: 92vh;
	overflow: auto;           /* iOS/Android éƒ½èƒ½åœ¨å¡ç‰‡å…§æ²å‹• */	
  }
  .modal-close{ padding:8px 14px; border:none; border-radius:8px; color:#fff; cursor:pointer; }
</style>

</head>
<body>
<div class="wrap">

  <!-- é ‚éƒ¨å°è¦½ï¼šå›é¦–é  / ä¿®æ”¹å¯†ç¢¼ -->
  <div class="topbar">
    <h1 style="margin:0;">å€‹äººä»‹é¢</h1>
    <div>
      <a class="link" href="{{ url_for('index') }}">å›é¦–é </a>
      &nbsp;|&nbsp;
      <a class="link" href="{{ url_for('change_password') }}">ä¿®æ”¹å¯†ç¢¼</a>
	  <a href="{{ url_for('my_likes') }}">æˆ‘æŒ‰éçš„è®š</a>
    </div>
  </div>

  <!-- Flash è¨Šæ¯ï¼ˆå¦‚æ›´æ–°æˆåŠŸ/å¤±æ•—ï¼‰ -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for m in messages %}
        <div class="flash">{{ m }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="grid">
    <!-- å·¦å´ï¼šé ­åƒå¡ç‰‡ -->
<div class="card">
  <h2>é ­åƒ</h2>

  <!-- é¡¯ç¤ºç›®å‰é ­åƒ -->
<img id="avatarImg"
     class="avatar"
     src="{{ url_for('static', filename=user['avatar_path']) if user['avatar_path'] else url_for('static', filename='img/default-avatar.png') }}"
     alt="avatar">


  <!-- æª”æ¡ˆé¸æ“‡åˆ—ï¼ˆé¿å…æ’çˆ†ï¼‰ -->
  <div class="avatar-form file-row" style="margin-top:12px">
    <!-- éš±è— inputï¼Œäº¤ç”±æŒ‰éˆ•è§¸ç™¼ -->
    <input id="avatarFile" type="file" accept="image/*" style="display:none" />
    <button id="avatarUploadBtn">ä¸Šå‚³æ–°é ­åƒ</button>
  </div>
</div>

    <!-- å³å´ï¼šåŸºæœ¬è³‡æ–™å¡ç‰‡ -->
    <div class="card">
      <h2 style="margin:0 0 12px;">å€‹äººè³‡æ–™</h2>
      <div class="meta" style="margin-bottom:6px;">Emailï¼š{{ user.email }}</div>
      <div class="meta" style="margin-bottom:6px;">åŠ å…¥æ™‚é–“ï¼š{{ user.created_at }}</div>
      <div class="meta" style="margin-bottom:12px;">æˆ‘çš„çµæœæ•¸é‡ï¼š{{ total_results }}</div>

      <!-- æ›´æ–°åç¨±èˆ‡è‡ªæˆ‘ä»‹ç´¹ -->
      <form method="post" action="{{ url_for('profile_update') }}">
        <div class="row">
          <label>ç”¨æˆ¶åç¨±</label>
          <input type="text" name="name" value="{{ user.name }}" required>
        </div>
        <div class="row">
          <label>è‡ªæˆ‘ä»‹ç´¹</label>
          <textarea name="bio" rows="4" placeholder="å¯«é»é—œæ–¼ä½ è‡ªå·±å§ï½">{{ user.bio or '' }}</textarea>
        </div>
        <button type="submit">æ›´æ–°å€‹äººè³‡æ–™</button>
      </form>
    </div>
  </div>



  <!-- [ADD] æˆ‘ç™¼å¸ƒéçš„è²¼æ–‡ -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin-top:0;">ğŸ“ æˆ‘ç™¼å¸ƒéçš„è²¼æ–‡</h3>
    {% if my_posts %}
      {% for p in my_posts %}
        <div id="post-{{ p.id }}" style="border-top:1px solid #eee; padding-top:10px; margin-top:10px">
          {% if p.content %}
            <div style="white-space:pre-wrap; line-height:1.6">{{ p.content }}</div>
          {% endif %}
          {% if p.image_path %}
            <img
              src="{{ url_for('static', filename=p.image_path) }}"
              alt=""
              style="width:100%;max-width:680px;border-radius:10px;margin-top:8px"
            >
          {% endif %}
          <div style="color:#666; font-size:14px; margin-top:6px;">
            ç™¼å¸ƒæ™‚é–“ï¼š{{ p.created_at }}
            Â· <a href="{{ url_for('post_detail', pid=p.id) }}" style="text-decoration:none; color:#2563eb;">å‰å¾€è²¼æ–‡</a>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">ä½ é‚„æ²’æœ‰ç™¼å¸ƒéè²¼æ–‡ã€‚</p>
    {% endif %}
  </div>


</div>
  <!-- Cropper.jsï¼ˆCDNï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>

  <!-- (A) è£åˆ‡é ­åƒç”¨çš„ Modal -->
<!-- è£åˆ‡å½ˆçª—ï¼šid å¿…é ˆæ˜¯ avatarCropperModal -->
<div id="avatarCropperModal" class="modal-mask" style="display:none">
  <div class="modal-card" style="max-width:1000px;">
    <h3 style="margin-top:0">è£åˆ‡é ­åƒ</h3>
    <div style="display:flex; gap:20px; flex-wrap:wrap">

      <!-- å·¦ï¼šè£åˆ‡ç”¨å½±åƒï¼ˆid=cropperSourceï¼‰ -->
      <div style="flex:1 1 560px; min-width:280px;">
        <img id="cropperSource" style="max-width:100%; display:block;" />
      </div>

      <!-- å³ï¼šåœ“å½¢é è¦½ï¼ˆid=cropperPreviewï¼‰ï¼Œç”¨ CSS åšåœ“å½¢é®ç½© -->
      <div style="flex:0 0 300px;">
        <div id="cropperPreview"
             style="width:260px;height:260px;border-radius:50%;
                    overflow:hidden;background:#f3f4f6;border:1px solid #ddd;"></div>
        <div class="meta" style="margin-top:8px;">åœ“å½¢å€åŸŸç‚ºæœ€çµ‚é ­åƒé è¦½</div>
      </div>
    </div>

    <!-- å·¥å…·åˆ— -->
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
      <button id="cropperRotateL">â†¶ æ—‹è½‰</button>
      <button id="cropperRotateR">â†· æ—‹è½‰</button>
      <button id="cropperZoomIn">ï¼‹ æ”¾å¤§</button>
      <button id="cropperZoomOut">ï¼ ç¸®å°</button>
      <div style="flex:1"></div>
      <button id="cropperCancel" class="danger">å–æ¶ˆ</button>
      <button id="cropperConfirm" class="primary">è£åˆ‡ä¸¦ä¸Šå‚³</button>
    </div>
  </div>
</div>


<!-- åŸåœ–é è¦½å½ˆçª—ï¼šid å¿…é ˆæ˜¯ avatarPreviewModal -->
<div id="avatarPreviewModal" class="modal-mask" style="display:none">
  <div class="modal-card" style="max-width:900px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0"></h3>
      <button id="avatarPreviewClose">é—œé–‰</button>
    </div>
    <img id="avatarPreviewImg" style="max-width:100%; display:block; margin-top:10px;" />
  </div>
</div>


  <script>
  (function(){
    // ===== DOM åƒç…§ =====
    const avatarImg       = document.getElementById('avatarImg');
    const fileInput       = document.getElementById('avatarFile');
    const uploadBtn       = document.getElementById('avatarUploadBtn');

    const cropperModal    = document.getElementById('avatarCropperModal');
    const cropperSource   = document.getElementById('cropperSource');
    const cropperPreview  = document.getElementById('cropperPreview');

    const btnRotateL      = document.getElementById('cropperRotateL');
    const btnRotateR      = document.getElementById('cropperRotateR');
    const btnZoomIn       = document.getElementById('cropperZoomIn');
    const btnZoomOut      = document.getElementById('cropperZoomOut');
    const btnCancel       = document.getElementById('cropperCancel');
    const btnConfirm      = document.getElementById('cropperConfirm');

    const previewModal    = document.getElementById('avatarPreviewModal');
    const previewImg      = document.getElementById('avatarPreviewImg');
    const previewClose    = document.getElementById('avatarPreviewClose');

    let cropper = null;
    let objectURL = null;

    // ===== 1) é»ã€Œä¸Šå‚³æ–°é ­åƒã€â†’ è§¸ç™¼é¸æª” =====
    uploadBtn?.addEventListener('click', () => fileInput?.click());

    // ===== 2) é¸æª”å¾Œé–‹è£åˆ‡è¦–çª— =====
    fileInput?.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      // å»ºç«‹æš«æ™‚ URL é¡¯ç¤ºåŸåœ–
      if(objectURL) URL.revokeObjectURL(objectURL);
      objectURL = URL.createObjectURL(file);
      cropperSource.src = objectURL;

      // é–‹å•Ÿ modal
      cropperModal.style.display = 'flex';

      // ç­‰åœ–ç‰‡è¼‰å…¥å¾Œå†å•Ÿå‹• Cropper
      cropperSource.onload = () => {
        cropper?.destroy?.();
        cropper = new Cropper(cropperSource, {
          aspectRatio: 1,           // æ­£æ–¹å½¢è£åˆ‡ï¼Œé¡¯ç¤ºæˆåœ“ç”± CSS æ±ºå®š
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          guides: false,
          background: true,
          minCropBoxWidth: 120,
          minCropBoxHeight: 120,
          preview: cropperPreview,  // å³å´åœ“å½¢é è¦½
        });
      };
    });

    // ===== 3) è£åˆ‡å·¥å…·åˆ— =====
    btnRotateL?.addEventListener('click', () => cropper?.rotate(-90));
    btnRotateR?.addEventListener('click', () => cropper?.rotate(90));
    btnZoomIn ?.addEventListener('click', () => cropper?.zoom(0.1));
    btnZoomOut?.addEventListener('click', () => cropper?.zoom(-0.1));
    btnCancel ?.addEventListener('click', () => closeCropper());

    function closeCropper(){
      cropper?.destroy?.();
      cropper = null;
      cropperModal.style.display = 'none';
      if(objectURL){ URL.revokeObjectURL(objectURL); objectURL = null; }
      fileInput.value = ''; // æ¸…ç©ºé¸æª”
    }

    // ===== 4) ç¢ºèªè£åˆ‡ä¸¦ä¸Šå‚³ =====
    btnConfirm?.addEventListener('click', async () => {
      if(!cropper) return;

      // å–å¾—è£åˆ‡å¾Œæ–¹å½¢åœ–ï¼ˆå»ºè­° 512x512ï¼‰ä¸¦å¥—åœ“å½¢é®ç½©è¼¸å‡ºæˆ PNG
      const squareCanvas = cropper.getCroppedCanvas({ width: 512, height: 512 });
      const roundCanvas  = document.createElement('canvas');
      roundCanvas.width  = 512;
      roundCanvas.height = 512;
      const ctx = roundCanvas.getContext('2d');
      ctx.beginPath();
      ctx.arc(256, 256, 256, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(squareCanvas, 0, 0, 512, 512);

      roundCanvas.toBlob(async (blob) => {
        if(!blob) return alert('åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦');
        const formData = new FormData();
        formData.append('avatar', new File([blob], 'avatar.png', { type: 'image/png' }));

        // ===== å¾Œç«¯è·¯ç”±ï¼š/profile/avatar ï¼ˆä¸‹ä¸€æ®µæœƒæä¾› app.py ç«¯é»ï¼‰
        const res = await fetch('/profile/avatar', { method: 'POST', body: formData });
        if(!res.ok){
          alert('ä¸Šå‚³å¤±æ•—');
          return;
        }
        const data = await res.json();
        if(data.ok){
          // æ›´æ–°é é¢é ­åƒï¼ˆé¿å…å¿«å–ï¼Œç”¨æ™‚é–“æˆ³ï¼‰
          const url = data.url + (data.url.includes('?') ? '&' : '?') + 't=' + Date.now();
          avatarImg.src = url;
          closeCropper();
        }else{
          alert(data.msg || 'ä¸Šå‚³å¤±æ•—');
        }
      }, 'image/png', 0.95);
    });

    // ===== 5) é»é ­åƒ â†’ çœ‹åŸåœ–ï¼ˆå¤§åœ–é è¦½ï¼‰ =====
    avatarImg?.addEventListener('click', () => {
      // é€™è£¡ç”¨ç›®å‰é ­åƒ URL ç•¶åŸåœ–ï¼ˆè‹¥ä½ å¾Œç«¯æœ‰å¦å­˜åŸåœ–ï¼Œå¯å›å‚³åŸåœ– URL å–ä»£ï¼‰
      previewImg.src = avatarImg.src.replace(/\?t=\d+$/, '');
      previewModal.style.display = 'flex';
    });
    previewClose?.addEventListener('click', () => previewModal.style.display = 'none');
    previewModal?.addEventListener('click', (e) => {
      if(e.target === previewModal) previewModal.style.display = 'none';
    });
  })();
  </script>

</body>
</html>
