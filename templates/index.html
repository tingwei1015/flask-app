<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é‰¤ç¹”åœ–è¾¨è­˜ç³»çµ±</title>
  <style>
    /* ==============================
				ç‰ˆé¢èˆ‡æ–‡å­—è¨­å®š
       - è¨­å®šå­—é«”ã€é é¢ç•™ç™½ã€èƒŒæ™¯è‰²èˆ‡æ–‡å­—å¤§å°
       ============================== */
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f9f9f9;
      color: #333;
      font-size: 18px;
    }
    /* ==============================
       ğŸ· ä¸»æ¨™é¡Œæ¨£å¼
       - ç½®ä¸­ã€èª¿è‰²èˆ‡å­—ç´š
       ============================== */
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #444;
      font-size: 30px;
    }
    /* ==============================
       - è™›ç·šæ¡† + ç™½åº• + åœ“è§’
       - ç½®ä¸­å°é½Š
       ============================== */
    .upload-box {
      text-align: center;
      margin-bottom: 10px;
      padding: 20px;
      border: 2px dashed #aaa;
      border-radius: 10px;
      background: #fff;
    }
    /* ä¸Šå‚³ input èˆ‡æŒ‰éˆ•çš„é–“è· */
    .upload-box input[type="file"] {
      margin: 10px 0;
    }
    /* ä¸»è¦æŒ‰éˆ•ï¼ˆä¸Šå‚³ä¸¦è¾¨è­˜ï¼‰ */
    .upload-box button {
      margin-top: 1px;
      padding: 12px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 6px;
      background-color: #967AA1;
      color: white;
      cursor: pointer;
    }
    .upload-box button:hover {
      background-color: #AAA1C8;
    }

    /* ==============================
				ç›¸æ©Ÿ
       ============================== */
/* è®“ç›¸æ©ŸæŒ‰éˆ•èˆ‡ä¸Šå‚³ä¸¦è¾¨è­˜å¤–è§€ä¸€è‡´ï¼ˆåŒè‰²ç³»ã€åŒå¤§å°ï¼‰ */
	.upload-box .camera-btn {
	display: inline-block;
	margin-left: 10px;
	vertical-align: middle;
	padding: 12px 20px;
	font-size: 1.1em;
	border: none;
	border-radius: 6px;
	background-color: #967AA1; /* èˆ‡ä¸Šå‚³ä¸¦è¾¨è­˜ä¸€è‡´ */
	color: white;
	cursor: pointer;
}
	.upload-box .camera-btn:hover { background-color: #AAA1C8; }

	.btn-row {
	display: flex;
	justify-content: center;   /* æ”¹ç‚ºç½®ä¸­ï¼Œè€Œéå…©é‚Šåˆ†æ•£ */
	align-items: center;
	gap: 20px;                 /* æ§åˆ¶å…©é¡†æŒ‰éˆ•çš„è·é›¢ï¼Œèˆ‡ä¸‹æ–¹ä¸€è‡´ */
	margin-top: 10px;
}



    /* ==============================
       âœ… å‹¾é¸é¸é …ï¼ˆåŸåœ–/åœˆåœ–ï¼‰
       ============================== */
    .checkbox-area {
      text-align: center;
      margin-top: 20px;
      font-size: 18px;
      color: #333;
    }
    .checkbox-area label {
      margin: 0 15px;
    }
    /* é€²åº¦æ¢æ¨£å¼ */
    .progress-container {
      width: 80%;
      margin: 20px auto;
      height: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #eee;
      display: none;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: #D5C6E0;
      border-radius: 10px;
      transition: width 0.2s;
    }
    .progress-text {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
      display: none;
    }

    /* é¡¯ç¤ºä½¿ç”¨è€…èˆ‡ç™»å‡º */
    .top-right {
      text-align: right;
      margin-bottom: 12px;
    }
    .top-right a { color:#967AA1; margin-left:12px; text-decoration:none; }

    /* åŠŸèƒ½æŒ‰éˆ•ï¼ˆä½¿ç”¨èªªæ˜ / é—œæ–¼æœ¬ç³»çµ±ï¼‰ */
    .action-btns {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .guide-btn, .about-btn {
      margin-top: 15px;
      padding: 10px 20px;
      border: 2px solid #6b7280;
      border-radius: 8px;
      background: #fff;
      color: #444;
      font-size: 16px;
      cursor: pointer;
      transition: 0.25s;
    }
    .guide-btn:hover, .about-btn:hover { background:#f3f4f6; }

    /* é€šç”¨å½ˆçª—æ¨£å¼ */
    .modal-mask {
      display:none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      z-index:9999;
      justify-content:center;
      align-items:center;
      padding: 20px;
      box-sizing: border-box;
    }
    .modal-card {
      background:white;
      border-radius:12px;
      padding:25px;
      width:85%;
      max-width:650px;
      box-shadow:0 4px 15px rgba(0,0,0,0.3);
      text-align:left;
    }
    .modal-card h2 {
      text-align:center; color:#444; margin-top:0;
    }
    .modal-card p { line-height:1.8; color:#333; }
    .modal-actions { text-align:center; margin-top:20px; }
    .modal-close {
      padding:8px 18px;
      background:#967AA1;
      color:white;
      border:none;
      border-radius:8px;
      font-size:16px;
      cursor:pointer;
    }

    /* ==============================
       ğŸ“¸ ç›¸æ©Ÿ Modal å…§éƒ¨å…ƒä»¶ï¼ˆè¦–è¨Š/ç•«å¸ƒ/æŒ‰éˆ•ï¼‰
       - videoï¼šå³æ™‚é è¦½
       - canvasï¼šæ‹ç…§å¾Œçš„éœæ…‹é è¦½
       ============================== */
    .camera-wrap { text-align:center; }
    #cameraVideo, #cameraCanvas {
      width: 100%;
      max-width: 560px;
      border-radius: 8px;
      background: #000; /* æœªå•Ÿå‹•æ™‚é»‘åº• */
    }
    .camera-controls {
      margin-top: 12px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .camera-controls button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      background: #6b7280;
      color: #fff;
    }
    .camera-controls button.secondary { background: #9ca3af; }
    .camera-controls button.danger { background: #ef4444; }
    .camera-controls button.primary { background: #967AA1; }
		/* é ‚éƒ¨æ©«åˆ—ï¼šå·¦é‚Šä¸‰é¡† + å³é‚Šä½¿ç”¨è€…å€ */
	.topbar{
	  display:flex;
	  justify-content:space-between;
	  align-items:center;
	  gap:12px;
	  width:100%;
	  /* æ¡Œæ©Ÿä¿æŒåŒä¸€è¡Œ */
	  flex-wrap:nowrap;
	  margin-bottom:12px;
	}

	/* å·¦å´ä¸‰é¡†æ©«å‘æ’åˆ— */
	.top-left{
	  display:flex;
	  align-items:center;
	  gap:10px;
	  flex-wrap:nowrap;
	}

	/* å³å´å€ä¿ç•™ä½ çš„æ¨£å¼ï¼›å¦‚æœä½ åŸæœ¬æœ‰ .top-right çš„è¨­å®šå¯å…±å­˜ */
	.top-right a{ color:#967AA1; margin-left:12px; text-decoration:none; }

	/* æŠŠã€ŒæŸ¥çœ‹æˆ‘çš„çµæœã€æŠ½æˆ classï¼Œç¶­æŒä½ åŸæœ¬çš„å¤–è§€ */
	.pill-link{
	  text-decoration:none;
	  color:#333;
	  background:#e0e0e0;
	  padding:8px 14px;
	  border-radius:6px;
	  display:inline-block;
	}

	/* æ‰‹æ©Ÿæ™‚å†å…è¨±æ›è¡Œï¼Œé¿å…æ“ å£“é‡ç–Š */
	@media (max-width: 640px){
	  .topbar{ flex-wrap:wrap; }
	  .top-right{ width:100%; text-align:right; }
	}


  </style>
</head>
<body>
	<div class="topbar">
	  <div class="top-left">
		<a href="{{ url_for('history_page') }}" class="pill-link">ğŸ“œ æŸ¥çœ‹æˆ‘çš„çµæœ</a>
		<button id="guideBtn" class="guide-btn" type="button">ğŸ“˜ ä½¿ç”¨èªªæ˜</button>
		<button id="aboutBtn" class="about-btn" type="button">â„¹ï¸ é—œæ–¼æœ¬ç³»çµ±</button>
	  </div>
	  <div class="top-right">
		<span>ä½¿ç”¨è€…ï¼š{{ username }}</span>
		<a href="{{ url_for('feed') }}">è²¼æ–‡ç‰†</a>
		<a href="{{ url_for('my_likes') }}">æˆ‘æŒ‰éçš„è®š</a>
		<a href="{{ url_for('profile') }}">å€‹äººä»‹é¢</a>
		<a href="{{ url_for('logout') }}">ç™»å‡º</a>
	  </div>
	</div>
  <h1>é‰¤ç¹”åœ–è¾¨è­˜ç³»çµ±</h1>

  <div class="upload-box">
    <form id="uploadForm" action="/predict" method="post" enctype="multipart/form-data">
      <p style="font-size:20px;">è«‹ä¸Šå‚³ä¸€å¼µé‰¤ç¹”åœ–ï¼š</p>
      <input type="file" id="fileInput" name="file" accept="image/*" required>
      <!-- ğŸ”’ éš±è—çš„ç³»çµ±ç›¸æ©Ÿ fallback input
           - ç•¶ WebRTC å¤±æ•—æ™‚æœƒä»¥ JS è§¸ç™¼å®ƒ
           - capture="environment" ç›¡å¯èƒ½å•Ÿç”¨å¾Œé¡é ­ï¼ˆAndroid ç›¸å®¹æ€§è¼ƒä½³ï¼‰ -->
      <input type="file" id="captureInput" accept="image/*" capture="environment" style="display:none;">
	  <br>
	  <div class="btn-row">
		<button type="submit">ä¸Šå‚³ä¸¦è¾¨è­˜</button>
		<!-- âœ… ç›¸æ©ŸæŒ‰éˆ•æ”¾åœ¨é€™è£¡ï¼Œä¸¦æŒ‡å®šç‚º buttonï¼Œé¿å… Android ç•¶æˆ submit -->
		<button id="cameraBtn" class="camera-btn" type="button">ç›´æ¥æ‹ç…§ä¸Šå‚³</button>
	  </div>

      <div class="checkbox-area">
        <label><input type="checkbox" name="output_original"> è¼¸å‡ºåŸåœ–</label>
        <label><input type="checkbox" name="output_circle"> è¼¸å‡ºåœˆåœ–çµæœ</label>
        <!-- <label><input type="checkbox" name="save_history"> å„²å­˜æ­·å²ç´€éŒ„</label> -->
      </div>
	</form>
  </div>

  <!-- é€²åº¦æ¢ -->
  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="progress-text" id="progressText">ç³»çµ±æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œè«‹ç¨å€™ï¼š)</div>

  <!-- ä½¿ç”¨èªªæ˜å½ˆçª— -->
  <div id="guideModal" class="modal-mask">
    <div class="modal-card">
      <h2>ğŸ“˜ é‰¤ç¹”åœ–è¾¨è­˜ç³»çµ±ä½¿ç”¨èªªæ˜</h2>
      <ol style="line-height:1.8; font-size:17px; color:#333; padding-left: 1.1em;">
        <li>è«‹é»æ“Šã€Œé¸æ“‡æª”æ¡ˆã€ä¸Šå‚³ä¸€å¼µé‰¤ç¹”åœ–ï¼ˆæ”¯æ´ JPGã€PNGï¼‰ã€‚å»ºè­°åœ–åƒæ¸…æ™°ã€èƒŒæ™¯å–®ç´”ã€‚</li>
        <li>å¯å‹¾é¸ã€Œè¼¸å‡ºåŸåœ–ã€æˆ–ã€Œè¼¸å‡ºåœˆåœ–çµæœã€ï¼Œé¸æ“‡è¦é¡¯ç¤ºçš„çµæœã€‚</li>
        <li>ä¸Šå‚³å¾Œç³»çµ±æœƒè‡ªå‹•åˆ†æåœ–æ¡ˆï¼Œè¾¨è­˜å‡ºå„é‡æ³•ç¨®é¡èˆ‡æ•¸é‡ã€‚</li>
        <li>è¾¨è­˜å®Œæˆå¾Œï¼Œæ‚¨å¯å°‡çµæœå„²å­˜åˆ°ã€Œæˆ‘çš„çµæœã€ï¼Œä»¥ä¾¿æ—¥å¾Œå›é¡§æˆ–å†åˆ†æã€‚</li>
        <li>åœ¨ã€Œæ­·å²ç´€éŒ„ã€é é¢ä¸­ï¼Œå¯æŸ¥çœ‹ã€é‡æ–°å‘½åæˆ–åˆªé™¤å…ˆå‰çš„ç´€éŒ„ã€‚</li>
        <li>è‹¥è¦ç™»å‡ºï¼Œè«‹é»å³ä¸Šè§’ã€Œç™»å‡ºã€æŒ‰éˆ•ã€‚</li>
      </ol>
      <p style="margin-top:10px; color:#555; font-size:16px; line-height:1.6;">
        ğŸ’¡ æç¤ºï¼šè‹¥åœ–æ¡ˆåŒ…å«ç‰¹æ®Šæ‰‹ç¹ªç¬¦è™Ÿæˆ–å½±åƒæ¨¡ç³Šï¼Œè¾¨è­˜æº–ç¢ºç‡å¯èƒ½ç•¥æœ‰é™ä½ã€‚æ‹æ”æ™‚è«‹ä¿æŒå…‰ç·šå……è¶³ä¸¦é¿å…é™°å½±å¹²æ“¾ã€‚
      </p>
      <div class="modal-actions">
        <button id="closeGuide" class="modal-close">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- é—œæ–¼æœ¬ç³»çµ±å½ˆçª— -->
  <div id="aboutModal" class="modal-mask">
    <div class="modal-card">
      <h2>â„¹ï¸ é—œæ–¼æœ¬ç³»çµ±</h2>
      <p>
        ã€Œé‰¤ç¹”åœ–è¾¨è­˜ç³»çµ±ã€æ˜¯ä¸€æ¬¾å°ˆç‚ºé‰¤ç¹”æ„›å¥½è€…ã€è¨­è¨ˆå¸«èˆ‡å­¸ç¿’è€…æ‰“é€ çš„æ™ºæ…§è¼”åŠ©å·¥å…·ã€‚
        é€éæ•´åˆäººå·¥æ™ºæ…§ï¼ˆAIï¼‰å½±åƒè¾¨è­˜æŠ€è¡“èˆ‡ YOLO æ¨¡å‹ï¼Œæœ¬ç³»çµ±èƒ½è‡ªå‹•è§£æé‰¤ç¹”åœ–æ¨£ä¸­çš„å„ç¨®é‡æ³•ç¬¦è™Ÿï¼Œ
        ä¸¦å¿«é€Ÿè¨ˆç®—å‡ºå„é‡æ³•çš„æ•¸é‡ï¼Œå”åŠ©æ‚¨ç¯€çœæ‰‹å‹•åˆ†æçš„æ™‚é–“ã€‚
      </p>
      <p>
        ç„¡è«–æ‚¨æ˜¯è¦è¨˜éŒ„è‡ªå·±çš„ä½œå“ã€å­¸ç¿’ä¸åŒé‡æ³•çš„ä½¿ç”¨ï¼Œæˆ–æ˜¯å”åŠ©æ•´ç†å¤§é‡é‰¤ç¹”æ•™æï¼Œ
        æœ¬ç³»çµ±éƒ½èƒ½æˆç‚ºæ‚¨å¯é çš„å¤¥ä¼´ã€‚ç³»çµ±äº¦æä¾›ã€Œæ­·å²ç´€éŒ„ã€åŠŸèƒ½ï¼Œè®“ä½¿ç”¨è€…èƒ½éš¨æ™‚å›é¡§éå»çš„è¾¨è­˜çµæœã€‚
      </p>
      <p>
        ç›®å‰æ”¯æ´çš„é‡æ³•é¡å‹åŒ…æ‹¬ï¼šé–é‡ã€çŸ­é‡ã€ä¸­é•·é‡ã€é•·é‡ã€å¼•æ‹”é‡ã€çˆ†ç±³èŠ±é‡ã€æ£—å½¢é‡ã€ç‹—ç‰™é‡ç­‰å¤šç¨®ç¬¦è™Ÿï¼Œ
        ä¸¦æŒçºŒæ“´å……ä¸­ã€‚æ‚¨åªéœ€ä¸Šå‚³ä¸€å¼µæ¸…æ™°çš„é‰¤ç¹”åœ–ï¼Œå³å¯ç²å¾—è¾¨è­˜çµæœèˆ‡è¦–è¦ºåŒ–åœ–åƒåŠ æ–‡å­—æ•˜è¿°ã€‚
      </p>
      <div class="modal-actions">
        <button id="closeAbout" class="modal-close">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- ==========================
       ç›¸æ©Ÿå½ˆçª—ï¼ˆModalï¼‰
       - å…¥å£æŒ‰éˆ•ä½æ–¼ä¸Šå‚³è¡¨å–®æ—
       - å…§å« WebRTC è¦–è¨Šé è¦½èˆ‡æ‹ç…§/ä¸Šå‚³æ§åˆ¶
       ========================== -->
  <div id="cameraModal" class="modal-mask">
    <div class="modal-card">
      <h2>ğŸ“· ç›´æ¥æ‹ç…§ä¸Šå‚³</h2>
      <div class="camera-wrap">
	    <!-- è¦–è¨Šé è¦½ï¼ˆWebRTCï¼‰ï¼šplaysinline é˜² iOS è‡ªå‹•å…¨è¢å¹•ã€muted æé«˜è‡ªå‹•æ’­æ”¾æˆåŠŸç‡ -->
        <video id="cameraVideo" autoplay playsinline muted></video>
		<!-- ç•«å¸ƒï¼šæ‹ç…§å¾Œå°‡ video ç•«é¢ç¹ªè£½åˆ°æ­¤ï¼Œå‘ˆç¾éœæ…‹é è¦½ -->
        <canvas id="cameraCanvas" style="display:none;"></canvas>
		<!-- ç›¸æ©Ÿæ“ä½œæŒ‰éˆ•åˆ— -->
        <div class="camera-controls">
          <button id="startCamBtn" class="secondary">é–‹å•Ÿç›¸æ©Ÿ</button>
          <button id="captureBtn" class="primary">æ‹ç…§</button>
          <button id="retakeBtn" class="secondary" style="display:none;">é‡æ‹</button>
          <button id="uploadShotBtn" class="primary" style="display:none;">ä¸Šå‚³è¾¨è­˜</button>
          <button id="closeCamera" class="danger">é—œé–‰</button>
        </div>
      </div>
      <p style="margin-top:10px; color:#555; font-size:15px; line-height:1.6;">
        è‹¥ç„¡æ³•é–‹å•Ÿå¾Œé¡é ­ï¼Œè«‹å…è¨±ç€è¦½å™¨ç›¸æ©Ÿæ¬Šé™æˆ–æ”¹ç”¨ç³»çµ±ç›¸æ©Ÿæ‹ç…§å¾Œå†ç”±æª”æ¡ˆä¸Šå‚³ã€‚
      </p>
    </div>
  </div>

  <style>
  /* âœ… ä¿®æ”¹ checkbox é¡è‰² */
  .checkbox-area input[type="checkbox"] {
    accent-color: #ff6600;
    transform: scale(1.3);
    margin-right: 6px;
  }
  .checkbox-area label {
    font-size: 16px;
    margin-right: 15px;
    cursor: pointer;
  }
  .checkbox-area {
    margin-top: 10px;
  }
  </style>

  <script>
    // ä¸Šå‚³é€²åº¦æ¢æ§åˆ¶ï¼ˆä¿ç•™åŸé‚è¼¯ï¼‰
    document.getElementById("uploadForm").addEventListener("submit", function(e) {
      e.preventDefault(); // é˜²æ­¢è¡¨å–®ç›´æ¥é€å‡º
      const form = e.target;
      const fileInput = document.getElementById("fileInput");

      if (!fileInput.files.length) {
        alert("è«‹é¸æ“‡åœ–ç‰‡ï¼");
        return;
      }

      const formData = new FormData(form);

      // é¡¯ç¤ºé€²åº¦æ¢
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      progressContainer.style.display = "block";
      progressText.style.display = "block";
      progressBar.style.width = "0%";

      // æ¨¡æ“¬é€²åº¦æ¢
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 10; // æ¨¡æ“¬é€²åº¦
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + "%";
      }, 200);

      // é€å‡ºè¡¨å–®è³‡æ–™åˆ°å¾Œç«¯ /predict
      fetch(form.action, {
        method: form.method,
        body: formData
      }).then(response => response.text()).then(html => {
        clearInterval(interval);
        progressBar.style.width = "100%";

        setTimeout(() => {
          document.open();
          document.write(html);
          document.close();
        }, 300); // å»¶é²è®“ç”¨æˆ¶çœ‹åˆ°100%
      }).catch(err => {
        alert("ä¸Šå‚³å¤±æ•—ï¼š" + err);
      });
    });

    // ä½¿ç”¨èªªæ˜å½ˆçª—
    const guideBtn = document.getElementById("guideBtn");
    const guideModal = document.getElementById("guideModal");
    const closeGuide = document.getElementById("closeGuide");
    guideBtn.onclick = () => guideModal.style.display = "flex";
    closeGuide.onclick = () => guideModal.style.display = "none";
    guideModal.onclick = (e) => { if (e.target === guideModal) guideModal.style.display = "none"; };

    // é—œæ–¼æœ¬ç³»çµ±å½ˆçª—
    const aboutBtn = document.getElementById("aboutBtn");
    const aboutModal = document.getElementById("aboutModal");
    const closeAbout = document.getElementById("closeAbout");
    aboutBtn.onclick = () => aboutModal.style.display = "flex";
    closeAbout.onclick = () => aboutModal.style.display = "none";
    aboutModal.onclick = (e) => { if (e.target === aboutModal) aboutModal.style.display = "none"; };

    // âœ… ç›¸æ©Ÿæ‹ç…§ä¸Šå‚³ï¼ˆå…¥å£æŒ‰éˆ•ï¼‰
    const cameraBtn = document.getElementById("cameraBtn");
    const cameraModal = document.getElementById("cameraModal");
    const videoEl = document.getElementById("cameraVideo");
    const canvasEl = document.getElementById("cameraCanvas");
    const startCamBtn = document.getElementById("startCamBtn");
    const captureBtn = document.getElementById("captureBtn");
    const retakeBtn = document.getElementById("retakeBtn");
    const uploadShotBtn = document.getElementById("uploadShotBtn");
    const closeCamera = document.getElementById("closeCamera");
    const captureInput = document.getElementById("captureInput");

    let mediaStream = null;
    let capturedBlob = null;

    function stopStream() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }
    }

    // å…±ç”¨ä¸Šå‚³æµç¨‹ï¼ˆæä¾›çµ¦ WebRTC èˆ‡ capture input ä½¿ç”¨ï¼‰
    async function uploadWithProgress(formData) {
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      progressContainer.style.display = "block";
      progressText.style.display = "block";
      progressBar.style.width = "0%";

      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + "%";
      }, 200);

      const res = await fetch("/predict", { method: "POST", body: formData });
      const html = await res.text();
      clearInterval(interval);
      progressBar.style.width = "100%";
      setTimeout(() => {
        document.open();
        document.write(html);
        document.close();
      }, 300);
    }

    // å˜—è©¦å•Ÿå‹•å¾Œé¡é ­ï¼ˆWebRTCï¼‰
    // - exact â†’ ideal â†’ default çš„ä¸‰æ®µç­–ç•¥
    // - enumerateDevices å˜—è©¦æ›´ç²¾æº–åˆ‡æ›åˆ°ã€Œback/rear/environmentã€é¡é ­
    // - loadedmetadata å¾Œå† play() å¯é¿å…é»‘å±ï¼ˆiOS/Android å¸¸è¦‹å•é¡Œï¼‰
    async function tryStartBackCamera() {
      const isSecure = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if (!isSecure || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        return false; // éå®‰å…¨ç’°å¢ƒæˆ–ç€è¦½å™¨ä¸æ”¯æ´
      }
      try {
        // 1) åš´æ ¼è¦æ±‚å¾Œé¡é ­
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } }, audio: false });
        } catch {
          // 2) ç†æƒ³ä½¿ç”¨å¾Œé¡é ­
          try {
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio: false });
          } catch {
            // 3) ä»»æ„å¯ç”¨é¡é ­
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          }
        }

        // å˜—è©¦ enumerate è£ç½®ï¼Œæ‰¾åç¨±åŒ…å« back/rear/environment çš„é¡é ­ä¸¦åˆ‡æ›
        if (navigator.mediaDevices.enumerateDevices) {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const back = devices.find(d => d.kind === "videoinput" && /back|rear|environment/i.test(d.label));
          if (back) {
            try {
              stopStream();
              mediaStream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: back.deviceId } }, audio: false });
            } catch {}
          }
        }

        // ç¶å®šåˆ° <video>ï¼Œä¸¦ç¢ºä¿ loadedmetadata ä¹‹å¾Œå† play()
        videoEl.srcObject = mediaStream;

        try {
          if (videoEl.readyState < 2) {
            await new Promise((resolve) => {
              const handler = () => { videoEl.removeEventListener('loadedmetadata', handler); resolve(); };
              videoEl.addEventListener('loadedmetadata', handler, { once: true });
            });
          }
          await videoEl.play();
        } catch (err) {
          // æœ‰äº›ç€è¦½å™¨éœ€å»¶å¾Œä¸€å€‹ event loop å†å‘¼å« play()
          setTimeout(() => { videoEl.play().catch(()=>{}); }, 0);
        }

        // é¡¯ç¤ºé è¦½ã€éš±è—éœæ…‹åœ–ã€é‡ç½®æŒ‰éˆ•ç‹€æ…‹
        videoEl.style.display = "block";
        canvasEl.style.display = "none";
        retakeBtn.style.display = "none";
        uploadShotBtn.style.display = "none";
        capturedBlob = null;
        return true;
      } catch {
        return false; // WebRTC æµç¨‹å¤±æ•—ï¼ˆæ¬Šé™æˆ–è£ç½®é™åˆ¶ï¼‰
      }
    }

    // å•Ÿå‹•ç›¸æ©Ÿï¼šå„ªå…ˆ WebRTCï¼Œå¤±æ•—å‰‡æ”¹ç”¨ã€Œç³»çµ±ç›¸æ©Ÿã€æª”æ¡ˆ input
    async function startCamera() {
      const ok = await tryStartBackCamera();
      if (!ok) {
        // Android/Samsungï¼šéƒ¨åˆ†ç€è¦½å™¨ç¦æ­¢å° display:none çš„ input ç›´æ¥ click()
        // â†’ çŸ­æš«æŠŠ input æ“ºåˆ°ç•«é¢å¤–ï¼Œé»æ“Šå¾Œå†éš±è—
        captureInput.style.position = 'fixed';
        captureInput.style.left = '-9999px';
        captureInput.style.opacity = '0';
        captureInput.style.display = 'block';
        try {
          captureInput.click();
        } finally {
          setTimeout(() => { captureInput.style.display = 'none'; }, 0);
        }
      }
    }

    // å…¥å£ï¼šé»ç›¸æ©ŸæŒ‰éˆ• â†’ æ‰“é–‹ Modal â†’ å˜—è©¦å•Ÿå‹•ç›¸æ©Ÿï¼ˆæˆ– fallbackï¼‰
    cameraBtn && (cameraBtn.onclick = () => {
      cameraModal.style.display = "flex";
      startCamera();
    });

    // Modal å…§çš„ã€Œé–‹å•Ÿç›¸æ©Ÿã€ï¼šå¯é‡è©¦
    startCamBtn.onclick = () => startCamera();

    // æ‹ç…§ï¼šå°‡ video ç•«é¢ç•«åˆ° canvasï¼Œä¸¦è½‰ blob ä½œç‚ºéœæ…‹é è¦½
    captureBtn.onclick = () => {
      if (!mediaStream) return;
      const videoTrack = mediaStream.getVideoTracks()[0];
      const settings = videoTrack.getSettings ? videoTrack.getSettings() : {};
      const w = settings.width || videoEl.videoWidth || 1280;
      const h = settings.height || videoEl.videoHeight || 720;

      canvasEl.width = w;
      canvasEl.height = h;
      const ctx = canvasEl.getContext("2d");
      ctx.drawImage(videoEl, 0, 0, w, h);

      canvasEl.toBlob((blob) => {
        capturedBlob = blob;
        // åˆ‡æ›è‡³éœæ…‹é è¦½ï¼›ç‚ºçœé›»å°‡ç›¸æ©Ÿåœæ­¢
        videoEl.style.display = "none";
        canvasEl.style.display = "block";
        retakeBtn.style.display = "inline-block";
        uploadShotBtn.style.display = "inline-block";
        stopStream();
      }, "image/jpeg", 0.92);
    };

    // é‡æ‹ï¼šé‡æ–°å•Ÿå‹•ç›¸æ©Ÿï¼ˆå›åˆ°è¦–è¨Šé è¦½éšæ®µï¼‰
    retakeBtn.onclick = () => {
      startCamera();
    };

    // ä¸Šå‚³æ‹ç…§çµæœï¼šæ‰“åŒ…æˆ FormData ä¸€èµ·é€åˆ° /predict
    uploadShotBtn.onclick = async () => {
      if (!capturedBlob) {
        alert("è«‹å…ˆæ‹ç…§å†ä¸Šå‚³ã€‚");
        return;
      }
      const formData = new FormData();
      formData.append("file", new File([capturedBlob], "camera.jpg", { type: "image/jpeg" }));

      // åŒæ­¥ç›®å‰å‹¾é¸çš„è¼¸å‡ºé¸é …ï¼ˆåŸåœ–/åœˆåœ–ï¼‰
      const outputOriginal = document.querySelector('input[name="output_original"]');
      const outputCircle = document.querySelector('input[name="output_circle"]');
      if (outputOriginal && outputOriginal.checked) formData.append("output_original", "on");
      if (outputCircle && outputCircle.checked) formData.append("output_circle", "on");

      try {
        await uploadWithProgress(formData);
      } finally {
        cameraModal.style.display = "none";
      }
    };

    // é—œé–‰ç›¸æ©Ÿå½ˆçª—ï¼šé‡‹æ”¾ä¸²æµä¸¦é—œé–‰ Modal
    function closeCameraModal() {
      stopStream();
      cameraModal.style.display = "none";
    }

    // é—œé–‰äº‹ä»¶ï¼šæŒ‰ä¸‹é—œé–‰æŒ‰éˆ•æˆ–é»æ“Šé®ç½©å€åŸŸ
    const cameraModalEl = document.getElementById("cameraModal");
    const closeCameraBtn = document.getElementById("closeCamera");
    closeCameraBtn.onclick = () => closeCameraModal();
    cameraModalEl.onclick = (e) => { if (e.target === cameraModalEl) closeCameraModal(); };

    // ğŸ“¸ ç³»çµ±ç›¸æ©Ÿ fallbackï¼šä½¿ç”¨ capture input
    // - ä½¿ç”¨è€…æ‹å®Œç…§é¸å–å¾Œè§¸ç™¼ changeï¼Œç›´æ¥ä¸Šå‚³
    captureInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);

      // åŒæ­¥å‹¾é¸çš„è¼¸å‡ºé¸é …ï¼ˆåŸåœ–/åœˆåœ–ï¼‰
      const outputOriginal = document.querySelector('input[name="output_original"]');
      const outputCircle = document.querySelector('input[name="output_circle"]');
      if (outputOriginal && outputOriginal.checked) formData.append("output_original", "on");
      if (outputCircle && outputCircle.checked) formData.append("output_circle", "on");

      try {
        await uploadWithProgress(formData);
      } finally {
        captureInput.value = "";            // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡å¯å†æ¬¡è§¸ç™¼ change
        cameraModal.style.display = "none"; // é—œé–‰ Modal
        stopStream();                       // ä¿éšªï¼šé‡‹æ”¾å¯èƒ½æ®˜ç•™çš„ä¸²æµ
      }
    });
  </script>

</body>
</html>